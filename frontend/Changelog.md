# Frontend Changelog

## WIP

- **Fixed Docker build failure**: Complete TypeScript compilation and Docker configuration fixes
  - Removed `--only=production` flag from npm ci to include devDependencies needed for TypeScript/Vite build
  - Generated missing `package-lock.json` file required by npm ci
  - Fixed 24+ TypeScript compilation errors:
    - Added null checking for `scene.input.keyboard` access across Player.ts, ControlsSystem.ts, PlayerSystem.ts
    - Removed unused variable declarations across all system files
    - Fixed Phaser callback type mismatches with proper `ArcadePhysicsCallback` types
    - Fixed ImportMeta.env access with type assertion
    - Updated property type declarations to allow undefined keyboard inputs
  - Fixed Docker nginx user creation conflict with existing nginx group
- **MAJOR REFACTORING**: Extracted GameScene.ts into modular system architecture
  - **9 New System Modules**: Created focused, single-responsibility systems
    - `AssetLoader.ts` - Asset loading and management
    - `PlayerSystem.ts` - Player creation, movement, and state management
    - `EnemySystem.ts` - Enemy management and AI
    - `WorldGenerator.ts` - Procedural world generation and streaming
    - `NetworkSystem.ts` - Multiplayer networking and state synchronization
    - `CameraSystem.ts` - Side-scrolling camera management
    - `ControlsSystem.ts` - Input and touch controls
    - `PhysicsSystem.ts` - Collision detection and physics management
    - `GameStateManager.ts` - Game over, victory, restart, and level progression
  - **83% Code Reduction**: Reduced main scene from 1583 lines to ~280 lines
  - **Improved Maintainability**: Clear separation of concerns with single-responsibility systems
  - **Better Testability**: Each system can be tested independently
  - **Enhanced Reusability**: Systems can be reused across different scenes
  - **Future Extensibility**: Easy to add new systems or extend existing ones
  - **Dead Code Removal**: Deleted original GameScene.ts (1583 lines) and seamlessly replaced with modular architecture
  - **All Functionality Preserved**: No loss of features during refactoring, all existing scene references continue to work

- **MAJOR ENHANCEMENT**: Fixed and perfected parallax depth system
  - **Correct Parallax Hierarchy**: Fixed scroll factors for realistic depth perception
    - Background (furthest): 0.1 scroll factor - slowest movement
    - Far trees: 0.2 scroll factor
    - Mid trees: 0.4 scroll factor
    - Near trees: 0.7 scroll factor
    - Gameplay elements: 1.0 scroll factor - normal speed
  - **Accurate Tree Positioning**: Trees now positioned within background tree band (145-190px scaled to screen)
  - **Realistic Tree Scaling**: Near trees scaled much larger (1.0x-1.8x) for proper perspective depth
  - **Depth Layering Fix**: Changed tree depths from negative (-10) to positive (1-3) so trees appear in front of background
  - **Proper Z-Order**: Background=0, Trees=1-3, Player=10, Enemies=12, Projectiles=15

- **VISUAL ENHANCEMENT**: Enhanced parallax background system with multi-layer depth simulation
  - **Seamless Background Tiling**: Fixed horizontal background gaps with pixel-perfect integer positioning
  - **3-Layer Parallax Trees**: Implemented realistic depth simulation using both `winter_tree` and `tree` assets
    - **Far background** (scroll factor 0.2): Medium-sized trees with slight fade for distance effect
    - **Mid background** (scroll factor 0.5): Larger trees with moderate parallax scrolling
    - **Near background** (scroll factor 0.8): Large, full-opacity trees close to player
  - **Distance-Based Scaling**: Tree size varies with simulated distance (0.3x to 0.8x scale)
  - **Depth-Based Alpha**: Trees fade slightly with distance for atmospheric perspective (0.7 to 1.0 alpha)
  - **Proper Z-Layering**: Positive depth values ensure correct layering order
  - **Varied Tree Distribution**: Random selection between winter and regular trees for visual variety

- **BUG FIX**: Synchronized winter ground tiles between source and assets directories
  - Copied updated 32x32 pixel `winter_ground_upper_right.png` from `tiles/winter/` to `frontend/src/assets/winter/`
  - Synchronized all winter ground tile variants to ensure consistency
  - Fixed issue where game was using outdated tile assets instead of corrected versions

- **ENHANCEMENT**: Winter-themed world graphics implementation with intelligent tiling system
  - Replaced programmatically generated graphics with beautiful winter sprites from `Season_collection.png`
  - Updated to new winter background image `winter_bg.png` (288x208) with optimized scaling:
    - **Vertical scaling**: Background scales to fit full screen height exactly
    - **Horizontal tiling**: Background repeats seamlessly across world width
    - **Parallax effect**: 0.5x scroll factor for depth perception
  - Implemented intelligent winter ground tiling system using properly extracted 32x32 tiles:
    - `winter_ground_upper_left/middle/right.png` - For platform top edges with proper corners
    - `winter_ground_inner.png` - For platform interior areas
    - `winter_ground_lower_left/middle/right.png` - For platform bottom edges
  - Created `createWinterTiledPlatform()` method for seamless multi-tile platform construction
  - Updated ground platforms: 192px wide (6 tiles) × 64px high (2 tiles) for substantial terrain
  - Updated floating platforms: Variable width (96-192px, 3-6 tiles) × 32px high (1 tile) for variety
  - Added snowy winter trees (`tree.png`, `winter_tree.png`) for background decoration elements
  - Enhanced visual depth with proper parallax scrolling factors and authentic tile-based aesthetics

- **BUG FIX**: Fixed Game Over and Victory messages positioning
  - Game Over and Victory screens now always appear in center of visible screen area
  - Messages are positioned relative to camera center instead of fixed screen coordinates
  - Added `setScrollFactor(0)` to prevent UI elements from scrolling with camera
  - Fixed issue where messages could appear off-screen when world was scrolled

- **BUG FIX**: Fixed health and score display system
  - Health bar now updates when player takes damage from enemies
  - Score counter now increments when enemies are defeated
  - Added `health-changed` and `enemy-defeated` event emission in GameScene
  - UI components now receive proper event notifications for real-time updates

- **BUG FIX**: Fixed empty world on game restart
  - Added proper state reset in `init()` method to clear all world generation maps
  - Reset `chunksGenerated`, `visibleChunks`, `platformChunks`, and `backgroundElements` on restart
  - Reset multiplayer state variables to prevent state corruption
  - Ensured reliable world regeneration after game restart or level transition

- **MAJOR FEATURE**: Implemented complete side-scrolling system with procedural level generation
  - **Side-scrolling Camera**: Camera follows player with dead zone, world moves around player
  - **Extended World Bounds**: World extends from -2000 to 12000 pixels for infinite scrolling
  - **Procedural Generation**: Levels are generated in chunks as player explores
  - **Chunk-based System**: 1024px chunks with platforms, enemies, and background elements
  - **World Streaming**: Dynamic loading/unloading of chunks for memory efficiency
  - **Parallax Background**: Scrolling background with depth effect (0.5x scroll factor)
  - **Random Platform Generation**: Ground platforms and floating platforms in each chunk
  - **Procedural Enemies**: 1-3 randomly placed enemies per chunk (owlet/pink boss)
  - **Background Decorations**: Random trees with parallax scrolling (0.8x scroll factor)
  - **Memory Management**: Distant chunks are automatically unloaded to save resources
  - **Multiplayer Compatible**: Each player maintains their own camera view in multiplayer

- **BUG FIX**: Fixed "this.enemies is undefined" error in offline mode
  - Fixed initialization order issue where world generation tried to access enemy groups before they were created
  - Moved enemy and projectile group initialization to create() method before world generation
  - Offline mode now loads correctly without errors

- **MOBILE CONTROLS FIX**: Fixed mobile buttons broken by side-scrolling system
  - **Camera-Fixed UI**: Mobile buttons now stay fixed to camera with `setScrollFactor(0)`
  - **Input System**: Added proper `setPlayerInput()` method and mobile input state tracking
  - **Touch Integration**: Mobile touch inputs now work alongside keyboard and mouse inputs
  - **Better UX**: Added `pointerout` events to stop movement when finger leaves button
  - **Multiplayer Support**: Mobile inputs are properly synchronized in multiplayer mode

- **OFFLINE MODE FIX**: Fixed offline mode preservation during game restart and level transitions
  - Fixed issue where offline games would switch to online mode when restarting
  - Fixed issue where "next level" would return to menu instead of continuing in same mode
  - Modified `restartMultiplayerGame()` to preserve offline state when restarting
  - Added `startNextLevel()` method to handle level transitions while preserving game mode
  - Offline games now stay offline, online games stay online during all transitions
  - Added "Zurück zum Menü" option in victory screen for explicit menu return

- **CRITICAL BUG FIX**: Fixed "Field required" validation error during auto-rejoin after restart
  - Fixed issue where auto-rejoin was using server response data instead of original join parameters
  - Server was receiving only `{'character_type': 'hero1'}` instead of required `room_name` and `username`
  - Modified MenuScene to pass original join parameters (`originalRoomName`, `originalUsername`) to GameScene
  - Updated auto-rejoin logic to use stored original parameters instead of server response data
  - Added parameter validation and fallback defaults for rejoin process
  - Auto-rejoin after restart now works correctly with proper field validation

- **MAJOR MULTIPLAYER FIX**: Implemented proper game restart synchronization for multiplayer sessions
  - Fixed issue where only one player could see the other after restart
  - Added `restartMultiplayerGame()` method that properly leaves room before restart
  - Implemented automatic room rejoin after restart with `autoRejoinAfterRestart()`
  - Added comprehensive network entity cleanup before restart (`cleanupNetworkEntities()`)
  - Added registry-based state persistence across scene restarts
  - All players now properly see each other after any player restarts
  - Restart sequence: Leave Room → Clean Network State → Restart Scene → Auto-rejoin Room

- **BUG FIX**: Fixed critical sprite and physics body errors in network entity updates
  - Added comprehensive safety checks in `updateEnemiesFromServer`, `updateProjectilesFromServer`, and `updateNetworkPlayer`
  - Added try-catch blocks around sprite creation and updates to prevent crashes
  - Added sprite existence validation before calling setVelocity/setPosition methods
  - **NEW**: Added animation safety checks - validate sprite.anims exists before calling sprite.play()
  - **NEW**: Added physics body validation - check sprite.body exists before calling setVelocity()
  - **NEW**: Added automatic physics body recovery - attempt to enable physics if body is missing
  - **NEW**: Wrapped all animation code in try-catch blocks to prevent animation crashes
  - Improved error logging for better debugging of sprite creation, physics body, and animation failures
  - Network game now handles sprite creation, physics body, and animation failures gracefully without crashing

- **MAJOR MULTIPLAYER ARCHITECTURE REVISION**: Fixed hybrid client-server authority system
  - Restored client-side game state broadcasting for proper conflict resolution
  - Updated input action mapping to match server protocol (left/right/jump/shoot)
  - Implemented selective client reconciliation with higher thresholds for responsiveness
  - Added proper server state acceptance for enemies and projectiles
  - Modified broadcast throttle to 30fps for optimal conflict resolution
  - Enhanced network player management with server authority
  - Fixed client reconciliation to maintain local physics while accepting server corrections
  - Improved game state update handling for hybrid authority model

- **MAJOR FEATURE**: Implemented multiplayer rendering and synchronization
  - Added support for multiple player sprites in GameScene
  - Real-time player position updates from server game state
  - Network player rendering with visual differentiation (green tint)
  - Player ID tracking and local vs network player handling
  - Smooth position interpolation for network players
  - Automatic cleanup of disconnected players
- Fixed critical multiplayer bugs
  - Fixed player ID mismatch between server and client causing input issues
  - Fixed network player scaling (now matches local player size)
  - Fixed duplicate player rendering (local player appearing as network player)
  - Added proper single-player mode (no network players when alone)
  - Enhanced debugging and player state logging
  - Fixed timing issue: NetworkManager now stores player ID immediately on room_joined
  - Added fallback mechanisms to ensure player ID is available in GameScene
  - Fixed MenuScene DOM access error: Added null check for menuForm.node in connection status updates
- **MAJOR FIX**: Implemented server-authoritative physics to eliminate flickering
  - In multiplayer mode: Local player now follows server position exactly (no client physics)
  - Input system redesigned: Client only sends inputs to server, no local movement
  - Animation system updated: All animations driven by server state data
  - Offline mode preserved: Client physics still used when playing offline
  - Removed position threshold checks in multiplayer (server position is always correct)
- **NEW**: Added server-synchronized enemies for true multiplayer gaming
  - Multiplayer mode: Enemies managed by server, synchronized across all players
  - Offline mode: Enemies still created locally with client physics
  - Network enemies have visual differentiation (orange tint for owlets, pink for boss)
  - Server-side enemy AI with random movement and physics simulation
  - All players see the same enemy positions and movements in real-time
- **CRITICAL FIX**: Completely redesigned multiplayer input system
  - Fixed input flooding: Now only sends input on key state changes (not every frame)
  - Fixed character not stopping: Properly sends key release events (pressed=false)
  - Added input state tracking to prevent duplicate messages
  - Separated offline and multiplayer input handling for better reliability
  - Improved responsiveness and reduced server load significantly
- **MAJOR ARCHITECTURAL CHANGE**: Switched to client-side authoritative physics
  - **Why**: Server-side physics engine was causing sync issues, ground-level problems, and poor responsiveness
  - **Solution**: Use proven Phaser physics on client, server only relays state between players
  - **Benefits**: Immediate responsive controls, better collision detection, native shooting support
  - **Implementation**: Clients broadcast complete game state, server relays to other players
  - **Host System**: First player in room manages enemies/projectiles to prevent conflicts
  - **Collision Restoration**: Player-enemy and projectile-enemy collisions now work properly
  - **Shooting Fixed**: Local shooting with network projectile synchronization
- **CRITICAL TIMING FIX**: Fixed "Player not in any room" race condition
  - **Problem**: Clients started broadcasting game state before room join was fully confirmed
  - **Solution**: Added roomJoinConfirmed flag to prevent premature broadcasting
  - **Throttling**: Limited game state broadcasts to 10fps to reduce server load
  - **Confirmation**: Only broadcast after receiving room_joined confirmation or pre-confirmed player ID
  - **Result**: Eliminates NOT_IN_ROOM errors when joining/leaving rooms
- Changed keyboard controls: Space bar now shoots instead of jumping (up/w keys still handle jumping)
