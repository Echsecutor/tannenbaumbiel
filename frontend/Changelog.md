# Frontend Changelog

## WIP

- Added victory music functionality:
  - Integrated "Viktor Kraus - Victory!.mp3" as dedicated victory music
  - Victory music automatically plays when level completion is achieved, replacing background music
  - Background music seamlessly restores when advancing to next level
  - Victory music respects user audio settings and global mute status
  - Proper audio cleanup prevents memory leaks during scene transitions
  - Enhanced audio control system with dedicated methods for victory/background music switching
- Added victory cheat functionality:
  - Level indicator (center-top of screen) is now clickable with hover effect
  - Clicking the level indicator 5 times in a row within 2 seconds triggers instant level completion
  - Cheat includes visual feedback: level text scales on each click and shows green tint when activated
  - Cheat properly integrates with existing victory system and level progression
  - Click counter resets after 2 seconds of inactivity for security
  - Fixed level completion flag reset in init() method for proper level transitions and cheat reusability
  - Prevents multiple cheat activations within the same level instance
- Added visual documentation with Mermaid diagrams:
  - Boss Arena System Flow diagram showing tree boss mechanics and platform navigation
  - Level Progression Fix Flow diagram documenting the corrected advancement logic
  - Audio System Management Flow diagram showing music switching between background/victory
  - Game Architecture Overview diagram displaying modular system design
  - All diagrams saved in notes with usage instructions for future reference
- Added background music support:
  - Added "Run Game 2.mp3" as looping background music in GameScene
  - Integrated audio loading through AssetLoader system with new `loadAudioAssets()` method
  - Background music respects audio toggle settings from UI (localStorage preference)
  - Implemented real-time audio control with mute/unmute event listeners
  - Music automatically pauses/resumes when audio is toggled during gameplay
  - Proper cleanup on scene restart and shutdown to prevent memory leaks
  - Volume set to 30% for comfortable gameplay experience
- Implemented comprehensive level progression system:
  - Added level completion detection when player reaches the end of the world (200px before right boundary)
  - Created level state management in `GameStateManager` with level tracking and progression
  - Enhanced victory UI to show "Level X Complete!" message with next level button
  - Added level number display at the top center of the screen like "Level 1"
  - Implemented enemy scaling system where higher levels spawn more enemies (1-2 base, +1 every 2 levels, cap at 6)
  - Added boss enemy probability scaling (10% base, +5% per level, cap at 40% boss chance)
  - Level state persists through scene restarts and multiplayer transitions
  - Victory screen shows "Continue to Level X" button for smooth progression
  - Anti-bounce mechanism prevents multiple level completion triggers
  - Level information is passed between scenes and synchronized with UI
- Implemented Boss Arena system for dedicated boss fights:
  - Boss levels trigger every 5th level (5, 10, 15, etc.) with special arena generation
  - Created massive Tree Boss using winter_tree.png sprite scaled to half screen height (300 HP)
  - Tree boss remains stationary and throws stone projectiles at player using stone.png graphics
  - Boss stones deal 15 damage with physics-based trajectory targeting and bouncing
  - Designed special arena layout with climbing platforms on both sides for vertical navigation
  - Added moving platforms with up/down tween animations for dynamic traversal challenges
  - Boss arena features wide central ground, side climbing stairs, and exit platform
  - Boss levels only complete when boss is defeated (not by reaching world end)
  - UI displays "BOSS LEVEL X" in red text to distinguish from regular levels
  - Stone projectiles have collision with player, platforms, and moving platforms
  - Enhanced collision system supports moving platforms and boss stone mechanics
- Simplified background rendering for better performance:
  - Removed complex perspective tree layers from WorldGenerator
  - Background image now provides sufficient visual depth without additional complexity
  - Removed unused `winter_tree` and `tree` assets from AssetLoader
  - Cleaned up excessive debug console logs for chunk generation and world streaming
  - Updated player depth comments to reflect simplified background system
  - Reduced bundle size and improved game experience by removing unnecessary complexity
- Implemented multiplayer score system:
  - Changed score reward from 100 to 10 points per enemy defeated
  - Added score tracking to player state for network synchronization
  - Added multiplayer score display showing other players' scores in real-time
  - Extended UI to show both current player score and other players' scores
  - Score is now synchronized across all players in multiplayer games
  - Fixed offline mode score display not showing initial score of 0
  - Removed conflicting event listeners that prevented proper score updates
  - Added comprehensive debug logging for score system troubleshooting
  - Fixed TypeScript compilation errors in UIScene.ts and main.ts for production builds
  - Added setScrollFactor(0) to all UI elements to prevent camera scrolling issues
  - Implemented proper depth layering for UI element visibility
- Changed server URL configuration from environment variables to UI input:
  - Added server URL input field to menu form with default value `https://server.tannenbaumbiel.echsecutables.de/`
  - Server URL is now saved in localStorage for persistence
  - Removed dependency on `VITE_WS_URL` environment variable
  - Connection is initiated when user clicks "Online Spielen" instead of on application startup
  - Automatic conversion from HTTP/HTTPS URLs to WS/WSS protocols
  - Updated Dockerfile to remove unused `VITE_WS_URL` build argument
  - Updated both docker-compose.yml and docker-compose.prod.yml to remove `VITE_WS_URL` references
- Added fullscreen landscape mode support for mobile devices:
  - Automatic fullscreen mode activation on mobile devices after game loads
  - Cross-browser fullscreen API support (WebKit, standard, MS implementations)
  - Screen orientation lock to landscape mode when supported by device
  - Fullscreen button for manual control with auto-hide in fullscreen mode
  - Updated game resolution from 1024x768 to 1280x720 for optimal landscape aspect ratio
  - Enhanced game scale configuration with expandParent and fullscreenTarget options
  - Responsive CSS with fullscreen-optimized styles and dynamic viewport handling
  - Portrait mode warning message encouraging users to rotate their device
  - Enhanced mobile meta tags for web app capabilities and better mobile experience
  - Smooth orientation change handling with automatic game scale refresh
- Fixed mobile touch controls not working:
  - Mobile buttons were being covered by UIScene elements (Menu button, audio toggle)
  - Added proper depth management (depth 1000) to ensure mobile buttons appear above other UI elements
  - Repositioned mobile buttons to avoid conflicts with existing UI elements
  - Improved button visual feedback with white borders and bold text labels
  - Made buttons slightly smaller (120x120) and more opaque (0.4 alpha) for better visibility
  - Added mobile device detection and automatic show/hide functionality
  - Mobile controls now automatically hide on desktop and show only on mobile devices
  - Added comprehensive touch event debugging and improved viewport settings for mobile
  - Added both pointer and touch event handlers for better mobile compatibility
  - Improved interactive settings with pixelPerfect: false and alphaTolerance: 1
  - Fixed mobile input flow: Connected ControlsSystem to PlayerSystem to ensure mobile touch events reach player movement
  - Unified input handling across online/offline modes - both now use the same ControlsSystem input path
- Consolidated input system: Removed dead code and debugging logs, cleaned up PlayerSystem mobile input handling
- Fixed TypeScript compilation errors: Added esModuleInterop, allowSyntheticDefaultImports, and downlevelIteration to tsconfig.json
- Removed redundant mobile input methods and excessive debug logging from both ControlsSystem and PlayerSystem
- Fixed WebSocket Content Security Policy violation in production:
  - Auto-upgrade WebSocket URLs from `ws://` to `wss://` when page is served over HTTPS
  - Updated nginx CSP header to include `connect-src 'self' ws: wss: http: https:` directive
  - Fixed menu form HTML structure to prevent CSP meta tag injection outside document head
  - Moved menu-form.html from src/ to public/ directory for proper static asset serving
  - Moved all game assets from src/assets/ to public/assets/ for production build inclusion
  - Updated AssetLoader.ts paths to use /assets/ instead of /src/assets/
  - Updated nginx configuration to serve .html files and updated all asset path references
  - Resolves browser blocking of insecure WebSocket connections on HTTPS sites
- Fixed Docker production build to properly handle Vite environment variables (`VITE_API_URL`, `VITE_WS_URL`) at build time
- Added comprehensive error handling for WebSocket connection failures
- Added user-visible error messages when server connection fails
- Added real-time connection status indicator in menu form with "connecting", "connected", and "disconnected" states
- Improved NetworkManager with connection timeout handling and better error messages
- Added detailed logging for debugging WebSocket connection issues
- Fixed TypeScript compilation errors:
  - Fixed variable scope issue with `serverUrl` in main.ts catch block
  - Fixed error type handling in NetworkManager.ts catch block (unknown type safety)
- Fixed offline game functionality:
  - Separated network initialization from game startup to prevent network failures from blocking game
  - Added comprehensive error handling and logging for debugging game initialization issues
  - Simplified menu system: "Online Spielen" button is now hidden when server is unavailable
  - "Offline Spielen" button remains always visible for offline gameplay
  - Improved startOfflineGame to pass proper initialization parameters
  - Removed complex fallback menu system in favor of simpler hide/show button logic
  - Cleaned up index.html: removed connection-status element and CSS (now only in menu form)
  - Simplified NetworkManager connection status handling (no longer updates index.html)

- **Fixed Docker build failure**: Complete TypeScript compilation and Docker configuration fixes
  - Removed `--only=production` flag from npm ci to include devDependencies needed for TypeScript/Vite build
  - Generated missing `package-lock.json` file required by npm ci
  - Fixed 24+ TypeScript compilation errors:
    - Added null checking for `scene.input.keyboard` access across Player.ts, ControlsSystem.ts, PlayerSystem.ts
    - Removed unused variable declarations across all system files
    - Fixed Phaser callback type mismatches with proper `ArcadePhysicsCallback` types
    - Fixed ImportMeta.env access with type assertion
    - Updated property type declarations to allow undefined keyboard inputs
  - Fixed Docker nginx user creation conflict with existing nginx group
- **MAJOR REFACTORING**: Extracted GameScene.ts into modular system architecture
  - **9 New System Modules**: Created focused, single-responsibility systems
    - `AssetLoader.ts` - Asset loading and management
    - `PlayerSystem.ts` - Player creation, movement, and state management
    - `EnemySystem.ts` - Enemy management and AI
    - `WorldGenerator.ts` - Procedural world generation and streaming
    - `NetworkSystem.ts` - Multiplayer networking and state synchronization
    - `CameraSystem.ts` - Side-scrolling camera management
    - `ControlsSystem.ts` - Input and touch controls
    - `PhysicsSystem.ts` - Collision detection and physics management
    - `GameStateManager.ts` - Game over, victory, restart, and level progression
  - **83% Code Reduction**: Reduced main scene from 1583 lines to ~280 lines
  - **Improved Maintainability**: Clear separation of concerns with single-responsibility systems
  - **Better Testability**: Each system can be tested independently
  - **Enhanced Reusability**: Systems can be reused across different scenes
  - **Future Extensibility**: Easy to add new systems or extend existing ones
  - **Dead Code Removal**: Deleted original GameScene.ts (1583 lines) and seamlessly replaced with modular architecture
  - **All Functionality Preserved**: No loss of features during refactoring, all existing scene references continue to work

- **MAJOR ENHANCEMENT**: Fixed and perfected parallax depth system
  - **Correct Parallax Hierarchy**: Fixed scroll factors for realistic depth perception
    - Background (furthest): 0.1 scroll factor - slowest movement
    - Far trees: 0.2 scroll factor
    - Mid trees: 0.4 scroll factor
    - Near trees: 0.7 scroll factor
    - Gameplay elements: 1.0 scroll factor - normal speed
  - **Accurate Tree Positioning**: Trees now positioned within background tree band (145-190px scaled to screen)
  - **Realistic Tree Scaling**: Near trees scaled much larger (1.0x-1.8x) for proper perspective depth
  - **Depth Layering Fix**: Changed tree depths from negative (-10) to positive (1-3) so trees appear in front of background
  - **Proper Z-Order**: Background=0, Trees=1-3, Player=10, Enemies=12, Projectiles=15

- **VISUAL ENHANCEMENT**: Enhanced parallax background system with multi-layer depth simulation
  - **Seamless Background Tiling**: Fixed horizontal background gaps with pixel-perfect integer positioning
  - **3-Layer Parallax Trees**: Implemented realistic depth simulation using both `winter_tree` and `tree` assets
    - **Far background** (scroll factor 0.2): Medium-sized trees with slight fade for distance effect
    - **Mid background** (scroll factor 0.5): Larger trees with moderate parallax scrolling
    - **Near background** (scroll factor 0.8): Large, full-opacity trees close to player
  - **Distance-Based Scaling**: Tree size varies with simulated distance (0.3x to 0.8x scale)
  - **Depth-Based Alpha**: Trees fade slightly with distance for atmospheric perspective (0.7 to 1.0 alpha)
  - **Proper Z-Layering**: Positive depth values ensure correct layering order
  - **Varied Tree Distribution**: Random selection between winter and regular trees for visual variety

- **BUG FIX**: Synchronized winter ground tiles between source and assets directories
  - Copied updated 32x32 pixel `winter_ground_upper_right.png` from `tiles/winter/` to `frontend/src/assets/winter/`
  - Synchronized all winter ground tile variants to ensure consistency
  - Fixed issue where game was using outdated tile assets instead of corrected versions

- **ENHANCEMENT**: Winter-themed world graphics implementation with intelligent tiling system
  - Replaced programmatically generated graphics with beautiful winter sprites from `Season_collection.png`
  - Updated to new winter background image `winter_bg.png` (288x208) with optimized scaling:
    - **Vertical scaling**: Background scales to fit full screen height exactly
    - **Horizontal tiling**: Background repeats seamlessly across world width
    - **Parallax effect**: 0.5x scroll factor for depth perception
  - Implemented intelligent winter ground tiling system using properly extracted 32x32 tiles:
    - `winter_ground_upper_left/middle/right.png` - For platform top edges with proper corners
    - `winter_ground_inner.png` - For platform interior areas
    - `winter_ground_lower_left/middle/right.png` - For platform bottom edges
  - Created `createWinterTiledPlatform()` method for seamless multi-tile platform construction
  - Updated ground platforms: 192px wide (6 tiles) × 64px high (2 tiles) for substantial terrain
  - Updated floating platforms: Variable width (96-192px, 3-6 tiles) × 32px high (1 tile) for variety
  - Added snowy winter trees (`tree.png`, `winter_tree.png`) for background decoration elements
  - Enhanced visual depth with proper parallax scrolling factors and authentic tile-based aesthetics

- **BUG FIX**: Fixed Game Over and Victory messages positioning
  - Game Over and Victory screens now always appear in center of visible screen area
  - Messages are positioned relative to camera center instead of fixed screen coordinates
  - Added `setScrollFactor(0)` to prevent UI elements from scrolling with camera
  - Fixed issue where messages could appear off-screen when world was scrolled

- **BUG FIX**: Fixed health and score display system
  - Health bar now updates when player takes damage from enemies
  - Score counter now increments when enemies are defeated
  - Added `health-changed` and `enemy-defeated` event emission in GameScene
  - UI components now receive proper event notifications for real-time updates

- **BUG FIX**: Fixed empty world on game restart
  - Added proper state reset in `init()` method to clear all world generation maps
  - Reset `chunksGenerated`, `visibleChunks`, `platformChunks`, and `backgroundElements` on restart
  - Reset multiplayer state variables to prevent state corruption
  - Ensured reliable world regeneration after game restart or level transition

- **MAJOR FEATURE**: Implemented complete side-scrolling system with procedural level generation
  - **Side-scrolling Camera**: Camera follows player with dead zone, world moves around player
  - **Extended World Bounds**: World extends from -2000 to 12000 pixels for infinite scrolling
  - **Procedural Generation**: Levels are generated in chunks as player explores
  - **Chunk-based System**: 1024px chunks with platforms, enemies, and background elements
  - **World Streaming**: Dynamic loading/unloading of chunks for memory efficiency
  - **Parallax Background**: Scrolling background with depth effect (0.5x scroll factor)
  - **Random Platform Generation**: Ground platforms and floating platforms in each chunk
  - **Procedural Enemies**: 1-3 randomly placed enemies per chunk (owlet/pink boss)
  - **Background Decorations**: Random trees with parallax scrolling (0.8x scroll factor)
  - **Memory Management**: Distant chunks are automatically unloaded to save resources
  - **Multiplayer Compatible**: Each player maintains their own camera view in multiplayer

- **BUG FIX**: Fixed "this.enemies is undefined" error in offline mode
  - Fixed initialization order issue where world generation tried to access enemy groups before they were created
  - Moved enemy and projectile group initialization to create() method before world generation
  - Offline mode now loads correctly without errors

- **MOBILE CONTROLS FIX**: Fixed mobile buttons broken by side-scrolling system
  - **Camera-Fixed UI**: Mobile buttons now stay fixed to camera with `setScrollFactor(0)`
  - **Input System**: Added proper `setPlayerInput()` method and mobile input state tracking
  - **Touch Integration**: Mobile touch inputs now work alongside keyboard and mouse inputs
  - **Better UX**: Added `pointerout` events to stop movement when finger leaves button
  - **Multiplayer Support**: Mobile inputs are properly synchronized in multiplayer mode

- **OFFLINE MODE FIX**: Fixed offline mode preservation during game restart and level transitions
  - Fixed issue where offline games would switch to online mode when restarting
  - Fixed issue where "next level" would return to menu instead of continuing in same mode
  - Modified `restartMultiplayerGame()` to preserve offline state when restarting
  - Added `startNextLevel()` method to handle level transitions while preserving game mode
  - Offline games now stay offline, online games stay online during all transitions
  - Added "Zurück zum Menü" option in victory screen for explicit menu return

- **CRITICAL BUG FIX**: Fixed "Field required" validation error during auto-rejoin after restart
  - Fixed issue where auto-rejoin was using server response data instead of original join parameters
  - Server was receiving only `{'character_type': 'hero1'}` instead of required `room_name` and `username`
  - Modified MenuScene to pass original join parameters (`originalRoomName`, `originalUsername`) to GameScene
  - Updated auto-rejoin logic to use stored original parameters instead of server response data
  - Added parameter validation and fallback defaults for rejoin process
  - Auto-rejoin after restart now works correctly with proper field validation

- **MAJOR MULTIPLAYER FIX**: Implemented proper game restart synchronization for multiplayer sessions
  - Fixed issue where only one player could see the other after restart
  - Added `restartMultiplayerGame()` method that properly leaves room before restart
  - Implemented automatic room rejoin after restart with `autoRejoinAfterRestart()`
  - Added comprehensive network entity cleanup before restart (`cleanupNetworkEntities()`)
  - Added registry-based state persistence across scene restarts
  - All players now properly see each other after any player restarts
  - Restart sequence: Leave Room → Clean Network State → Restart Scene → Auto-rejoin Room

- **BUG FIX**: Fixed critical sprite and physics body errors in network entity updates
  - Added comprehensive safety checks in `updateEnemiesFromServer`, `updateProjectilesFromServer`, and `updateNetworkPlayer`
  - Added try-catch blocks around sprite creation and updates to prevent crashes
  - Added sprite existence validation before calling setVelocity/setPosition methods
  - **NEW**: Added animation safety checks - validate sprite.anims exists before calling sprite.play()
  - **NEW**: Added physics body validation - check sprite.body exists before calling setVelocity()
  - **NEW**: Added automatic physics body recovery - attempt to enable physics if body is missing
  - **NEW**: Wrapped all animation code in try-catch blocks to prevent animation crashes
  - Improved error logging for better debugging of sprite creation, physics body, and animation failures
  - Network game now handles sprite creation, physics body, and animation failures gracefully without crashing

- **MAJOR MULTIPLAYER ARCHITECTURE REVISION**: Fixed hybrid client-server authority system
  - Restored client-side game state broadcasting for proper conflict resolution
  - Updated input action mapping to match server protocol (left/right/jump/shoot)
  - Implemented selective client reconciliation with higher thresholds for responsiveness
  - Added proper server state acceptance for enemies and projectiles
  - Modified broadcast throttle to 30fps for optimal conflict resolution
  - Enhanced network player management with server authority
  - Fixed client reconciliation to maintain local physics while accepting server corrections
  - Improved game state update handling for hybrid authority model

- **MAJOR FEATURE**: Implemented multiplayer rendering and synchronization
  - Added support for multiple player sprites in GameScene
  - Real-time player position updates from server game state
  - Network player rendering with visual differentiation (green tint)
  - Player ID tracking and local vs network player handling
  - Smooth position interpolation for network players
  - Automatic cleanup of disconnected players
- Fixed critical multiplayer bugs
  - Fixed player ID mismatch between server and client causing input issues
  - Fixed network player scaling (now matches local player size)
  - Fixed duplicate player rendering (local player appearing as network player)
  - Added proper single-player mode (no network players when alone)
  - Enhanced debugging and player state logging
  - Fixed timing issue: NetworkManager now stores player ID immediately on room_joined
  - Added fallback mechanisms to ensure player ID is available in GameScene
  - Fixed MenuScene DOM access error: Added null check for menuForm.node in connection status updates
- **MAJOR FIX**: Implemented server-authoritative physics to eliminate flickering
  - In multiplayer mode: Local player now follows server position exactly (no client physics)
  - Input system redesigned: Client only sends inputs to server, no local movement
  - Animation system updated: All animations driven by server state data
  - Offline mode preserved: Client physics still used when playing offline
  - Removed position threshold checks in multiplayer (server position is always correct)
- **NEW**: Added server-synchronized enemies for true multiplayer gaming
  - Multiplayer mode: Enemies managed by server, synchronized across all players
  - Offline mode: Enemies still created locally with client physics
  - Network enemies have visual differentiation (orange tint for owlets, pink for boss)
  - Server-side enemy AI with random movement and physics simulation
  - All players see the same enemy positions and movements in real-time
- **CRITICAL FIX**: Completely redesigned multiplayer input system
  - Fixed input flooding: Now only sends input on key state changes (not every frame)
  - Fixed character not stopping: Properly sends key release events (pressed=false)
  - Added input state tracking to prevent duplicate messages
  - Separated offline and multiplayer input handling for better reliability
  - Improved responsiveness and reduced server load significantly
- **MAJOR ARCHITECTURAL CHANGE**: Switched to client-side authoritative physics
  - **Why**: Server-side physics engine was causing sync issues, ground-level problems, and poor responsiveness
  - **Solution**: Use proven Phaser physics on client, server only relays state between players
  - **Benefits**: Immediate responsive controls, better collision detection, native shooting support
  - **Implementation**: Clients broadcast complete game state, server relays to other players
  - **Host System**: First player in room manages enemies/projectiles to prevent conflicts
  - **Collision Restoration**: Player-enemy and projectile-enemy collisions now work properly
  - **Shooting Fixed**: Local shooting with network projectile synchronization
- **CRITICAL TIMING FIX**: Fixed "Player not in any room" race condition
  - **Problem**: Clients started broadcasting game state before room join was fully confirmed
  - **Solution**: Added roomJoinConfirmed flag to prevent premature broadcasting
  - **Throttling**: Limited game state broadcasts to 10fps to reduce server load
  - **Confirmation**: Only broadcast after receiving room_joined confirmation or pre-confirmed player ID
  - **Result**: Eliminates NOT_IN_ROOM errors when joining/leaving rooms
- Changed keyboard controls: Space bar now shoots instead of jumping (up/w keys still handle jumping)
